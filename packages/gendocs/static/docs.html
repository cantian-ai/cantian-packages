<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Elements in HTML</title>

    <script src="https://asset.cantian.ai/public/web-components.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@stoplight/elements/styles.min.css" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/fast-xml-parser/5.2.3/fxparser.min.js"
      integrity="sha512-qseMJNM3JypeSEmzVKH3EtgWqWKU2CbKEk5rTXsC143wjoMxvMjPwl8zYnNu7I6jQFZPdbl+KK8pQPGPcBwlhw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script type="module">
      import { resolveApiBase } from './env.js';

      const openapiSpec = {
        openapi: '3.0.4',
        info: {
          title: 'Cantian Open API',
          description: 'Cantian Open API for developers.',
        },
        components: {
          securitySchemes: {
            bearerAuth: {
              type: 'http',
              scheme: 'bearer',
              bearerFormat: 'JWT',
            },
          },
        },
        servers: [{ url: resolveApiBase() }],
        paths: {},
        security: [
          {
            bearerAuth: [],
          },
        ],
      };
      const preSendRequest = async ([, init]) => {
        const accessToken = await window.parent.getAccessToken();
        window.setOperationAuthValue({ authValue: accessToken, scheme: window.operationAuthValue[0].scheme });
        init.headers = { ...init.headers, Authorization: `Bearer ${accessToken}` };
      };
      const loadAzureSpecs = async (env) => {
        const url = `https://openapidocs.blob.core.windows.net/${env}/?restype=container&comp=list`;
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error();
        }
        const parser = new XMLParser.default();
        const text = await response.text();
        const object = parser.parse(text);
        const promises = [];
        // It's not an array when there is only one Blob.
        if (!Array.isArray(object.EnumerationResults.Blobs.Blob)) {
          object.EnumerationResults.Blobs.Blob = [object.EnumerationResults.Blobs.Blob];
        }
        for (const blob of object.EnumerationResults.Blobs.Blob) {
          promises.push(
            (async () => {
              const response = await fetch(blob.Url);
              if (response.ok) {
                const text = await response.text();
                const paths = JSON.parse(text);
                const result = {};
                for (const [path, methods] of Object.entries(paths)) {
                  for (const [method, spec] of Object.entries(methods)) {
                    if (window.parent.userScope === '*:admin' || !spec.tags.includes('*:admin')) {
                      result[path] = result[path] || {};
                      result[path][method] = spec;
                    }
                  }
                }
                return result;
              }
              throw new Error();
            })(),
          );
        }
        const results = await Promise.all(promises);
        for (const result of results) {
          openapiSpec.paths = {
            ...openapiSpec.paths,
            ...result,
          };
        }
        return openapiSpec;
      };
      const loadLocalSpecs = async () => {
        const response = await fetch('/openapi.json');
        const text = await response.text();
        const spec = JSON.parse(text);
        openapiSpec.paths = { ...openapiSpec.paths, ...spec };
        return openapiSpec;
      };
      window.preSendRequest = preSendRequest;
      (async () => {
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
          await loadLocalSpecs();
        } else {
          await loadAzureSpecs('dev');
        }
        const el = document.createElement('elements-api');
        el.apiDescriptionDocument = JSON.stringify(openapiSpec);
        el.router = 'hash';
        el.id = 'elements';
        el.preSendRequest = preSendRequest;
        document.body.appendChild(el);

        // docs.html 不再负责同步路由状态，保持为纯文档渲染页
      })();
    </script>
  </head>
  <body style="height: 100vh" id="" body></body>
</html>
